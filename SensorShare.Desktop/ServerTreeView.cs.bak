using System;
using System.ComponentModel;
using System.Collections;
using System.Collections.Generic;
using System.Diagnostics;
using System.Text;
using System.Windows.Forms;
using ScienceScope;
using System.Threading;
using System.Net;

namespace SensorShare.Desktop
{
    public class ServerTreeView : TreeView
    {
        protected Hashtable serverDataList = null;

        private ServerData serverToAdd = null;
        private IPAddress serverIPToRemove = null;
        private EventHandler addInvokeHandler = null;
        private EventHandler clearInvokeHandler = null;
        private EventHandler removeInvokeHandler = null;

        public ServerTreeView()
            : base()
        {
            this.serverDataList = new Hashtable(10);  // Will expact a capacity of no more than 10
            this.addInvokeHandler = new EventHandler(InvokedAdd);
            this.clearInvokeHandler = new EventHandler(ClearNodes);
            this.removeInvokeHandler = new EventHandler(InvokeRemove);
            this.AfterSelect += new TreeViewEventHandler(ServerListView_AfterSelect);
        }

        void ServerListView_AfterSelect(object sender, TreeViewEventArgs a)
        {
            if (a.Action == TreeViewAction.ByMouse)
            {
                if (nodesAndServerData.ContainsKey(a.Node))
                {
                    FireOnServerSelected((ServerData)nodesAndServerData[a.Node]);
                }
            }
        }

        public void Add(ServerData server)
        {
            serverToAdd = server;
            this.Invoke(addInvokeHandler);
        }

        private void InvokedAdd(object sender, EventArgs a)
        {
            if (serverDataList.ContainsKey(serverToAdd.ipEndPoint.Address.ToString()))
            {
                serverDataList[serverToAdd.ipEndPoint.Address.ToString()] = serverToAdd;
                RefreshTree();
            }
            else
            {
                serverDataList[serverToAdd.ipEndPoint.Address.ToString()] = serverToAdd;
                addServerNode(serverToAdd);
            }
        }

        private void RefreshTree()
        {
                this.Nodes.Clear();
                this.nodesAndServerData.Clear();
                foreach (Object serverData in serverDataList.Values)
                {
                    addServerNode((ServerData) serverData);
                }
        }

        private Hashtable nodesAndServerData = new Hashtable(10);

        private void addServerNode(ServerData server)
        {
            TreeNode newNode = new TreeNode(server.name);

            TreeNode connectNode = new TreeNode("Connect");
            newNode.Nodes.Add(connectNode);
            nodesAndServerData[connectNode] = server;

            newNode.Nodes.Add(server.description);

            TreeNode sensorsNode = new TreeNode("Sensors");
            foreach (SensorDefinition sensor in server.sensors)
            {
                sensorsNode.Nodes.Add(sensor.Description);
            }
            newNode.Nodes.Add(sensorsNode);
            this.Nodes.Add(newNode);
        }

        public void Remove(IPAddress serverIP)
        {
            serverIPToRemove = serverIP;
            this.Invoke(removeInvokeHandler);
        }

        private void InvokeRemove(object sender, EventArgs a)
        {
            serverDataList.Remove(serverIPToRemove.ToString());
            serverIPToRemove = null;
            RefreshTree();
        }

        public void Clear()
        {
            this.Invoke(clearInvokeHandler);
        }

        private void ClearNodes(object sender, EventArgs a)
        {
            this.serverDataList.Clear();
            this.Nodes.Clear();
        }
 
        public delegate void ServerSelectedEventHandler(object sender, ServerSelectedEventArgs e);

        public event ServerSelectedEventHandler ServerSelected;

        private void FireOnServerSelected(ServerData server)
        {
            if (ServerSelected != null)
            {
                ServerSelected(this, new ServerSelectedEventArgs(server));
            }
        }

    }

    public delegate void ServerSelectedEventHandler(object sender, ServerSelectedEventArgs e);

    public class ServerSelectedEventArgs : EventArgs
    {
        private readonly ServerData server;

        public ServerSelectedEventArgs(ServerData serverSelected)
            : base()
        {
            this.server = serverSelected;
        }

        public ServerData Server
        {
            get { return server; }
        }

    }
}
